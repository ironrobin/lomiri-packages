# Maintainer: Ivan Semkin (ivan at semkin dot ru)

pkgname=gmenuharness
_pkgname=gmenuharness
pkgver=0.1.4
pkgrel=0
pkgdesc="Testing enablement library for projects exporting GiO's gmenu/gaction endpoints"
url='https://gitlab.com/ubports/development/core/gmenuharness'
arch=(x86_64 i686 armv7h aarch64)
license=()
conflicts=(gmenuharness)
provides=(gmenuharness)
depends=(lomiri-api-git gtest libqtdbustest)
makedepends=(gtest cmake cmake-extras doxygen python-dulwich)
source=(
  "https://gitlab.com/ubports/development/core/gmenuharness/-/archive/${pkgver}/gmenuharness-${pkgver}.tar.gz"
  'debian-patches.tar.gz::https://salsa.debian.org/ubports-team/gmenuharness/-/archive/master/gmenuharness-master.tar.gz'
)
sha256sums=(
  'SKIP'
  'SKIP'
)

# pkgver() {
#   cd ${_pkgname}
#   ver="r$(git rev-list --count HEAD).$(git describe --always)"
#   echo "${ver//-/_}"            # only: hyphens â†’ underscores
# }

prepare() {
  cd "${_pkgname}-${pkgver}"

  # Apply Debian patches from the downloaded packaging repo, if present
  local patches_dir
  patches_dir=$(find "${srcdir}" -type d -path '*/debian/patches' -print -quit)
  if [[ -n "${patches_dir}" && -f "${patches_dir}/series" ]]; then
    while IFS= read -r p; do
      [[ -z "${p}" || "${p}" =~ ^# ]] && continue
      patch -Np1 -i "${patches_dir}/${p}"
    done < "${patches_dir}/series"
  fi
}

build() {
  cd "${_pkgname}-${pkgver}"
  cmake -DCMAKE_POLICY_VERSION_MINIMUM=3.5 -DCMAKE_INSTALL_PREFIX:PATH=/usr -DCMAKE_INSTALL_LIBDIR="lib/" .
  make -j8
}

# check() {
#   cd ${_pkgname}
#   make ARGS+="--output-on-failure" check
# }

package() {
  cd "${_pkgname}-${pkgver}"
  make DESTDIR="${pkgdir}/" install
}
# vim:set ts=2 sw=2 et:
