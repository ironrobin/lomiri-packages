# Maintainer: Ivan Semkin (ivan at semkin dot ru)
# Contributor: kikadf <kikadf.01@gmail.com>

pkgbase=mir
pkgname=mir
pkgver=2.22.0
pkgrel=0
pkgdesc="Canonical's display server"
url='https://mir-server.io'
arch=(x86_64 i686 aarch64)
license=(GPL LGPL)
depends=(gtest boost-libs capnproto google-glog gflags libglvnd  liburcu lttng-ust libepoxy libxml++2.6 nettle libinput libxkbcommon python-pillow freetype2 libevdev protobuf python-dbus python-gobject hicolor-icon-theme libxcursor yaml-cpp)
makedepends=(libdisplay-info git glm doxygen cmake boost gcovr gmock lcov valgrind python-dbusmock umockdev wlcs)
optdepends=('qterminal: required for miral demos'
            'ttf-ubuntu-font-family: required for miral demos'
            'qt5-wayland: required for miral demos'
            'xcursor-dmz: opt requirement for miral demos'
            'qtubuntu: opt requirement for miral demos')
source=("https://github.com/MirServer/mir/archive/v${pkgver}.tar.gz"
        "a701c3c9c1649a6959d4c0b1c7289ee83857633d.patch"
        "68480bc9654191b615b0e7b80c8a87599a417470.patch"
        "b8c2da5871a805602f40fc30abe1a6ac619916e2.patch"
        "0dfb6d76d04031441fb4d4fcb2e986f2874004a0.patch"
        "de9b340d823f4effff4c8d2b14b6c30e1f1c3097.patch"
        "30.patch"
        "https://github.com/MirServer/mir/commit/0f06a760676b9e5aa8320d0cb8e9c23a3419286d.patch"
        "https://github.com/MirServer/mir/commit/c457acd78a73e19d4f9129e7a18a9a59db2ed46c.patch")
sha256sums=('SKIP'
            '4c319549aaeda3c0f783f9d0515148f9fa2a13a9b02d025c6f235bc1bfd97523'
            '042862c7007c7fe2dd8f5407331fb1ae4dfba3894f5640d79e8b171659625246'
            '88f5aece46b599c8caa614390ee2a513d0db2c87f9a5400cf9e65bfece8489b6'
            '5135fd23978493ae73093b4c6b74f8865a3f419f0f799c4e8a7ed5e98fef9d2b'
            'f2769d8994f6c2c0ee29427575318e505a6fec7c0bca5fe199f0eb3c0df07fed'
            '2c1728fef9657fb2e21ee5894ed5cd96aadafd12a527309349b65d3f42d150f7'
            'SKIP'
            'SKIP')

build() {
  export CFLAGS+=" -ffat-lto-objects -O2"
  export CXXFLAGS+=" -ffat-lto-objects -O2"

  local _flags=(
    -B build 
    -S "${pkgname}-${pkgver}" 
    -GNinja
    -Wno-dev
    -DCMAKE_BUILD_TYPE=None
    -DCMAKE_INSTALL_PREFIX=/usr
    -DCMAKE_INSTALL_LIBDIR=lib
    # mir options
    -DMIR_FATAL_COMPILE_WARNINGS=OFF
    -DCMAKE_INSTALL_LIBEXECDIR=/usr/lib/$pkgname/
    -DMIR_BUILD_INTERPROCESS_TESTS=OFF
    -DMIR_RUN_WLCS_TESTS=OFF
    -DMIR_USE_PRECOMPILED_HEADERS=OFF
  )

  cmake "${_flags[@]}"
  cmake --build build
}

#check() {
#  ctest --test-dir build --output-on-failure
#}

package() {
  DESTDIR="${pkgdir}" cmake --install build
}
