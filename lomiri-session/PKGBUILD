# Maintainer: you <alex@ironrobin.net>
pkgname=lomiri-session
pkgver=0.3
pkgrel=4
pkgdesc="Lomiri desktop session integration (Wayland session, units, defaults)"
arch=('any')
url="https://salsa.debian.org/ubports-team/lomiri-session"
license=('GPL3')  # adjust if upstream lists differently
depends=(dbus systemd lomiri lomiri-keyboard)  # keep minimal; add more if the package ships hard runtime hooks
makedepends=(cmake pkgconf)
source=("git+https://gitlab.com/ubports/development/core/lomiri-session.git#tag=${pkgver}"
        "0001-Ensure-QML-sees-both-Lomiri-s-QML-and-the-Qt5-global.patch")
sha256sums=('b6cddb8e6fbfdc10490cedbacc17813b608ec74fd56a6ec8ec33f203c6dc1e0a'
            'a92a6d2dfa645398d3307dcd605ccf9b64833db85a957be840312b1586461849')

prepare() {
  cd "${srcdir}/${pkgname}"
  # Fetch Debian packaging repo to get the latest debian/patches series
  local debrepo="${srcdir}/debian-upstream"
  if [[ ! -d "$debrepo/.git" ]]; then
    git clone --depth=1 https://salsa.debian.org/ubports-team/lomiri-session.git "$debrepo"
  else
    git -C "$debrepo" fetch --depth=1 origin
    git -C "$debrepo" reset --hard origin/HEAD
  fi

  local series_file="$debrepo/debian/patches/series"
  if [[ ! -f "$series_file" ]]; then
    echo "debian/patches/series not found in $debrepo" >&2
    return 1
  fi

  # Apply patches in series order
  while IFS= read -r p || [[ -n "$p" ]]; do
    [[ -z "$p" || "$p" =~ ^# ]] && continue
    echo "Applying patch: $p"
    patch -Np1 -i "$debrepo/debian/patches/$p"
  done < "$series_file"
  # Apply local adjustments
  patch -Np1 -i "${srcdir}/0001-Ensure-QML-sees-both-Lomiri-s-QML-and-the-Qt5-global.patch"
}

build() {
  cd "${srcdir}/${pkgname}"
  cmake -S . -B build \
        -DENABLE_TOUCH_SESSION=OFF \
        -DCMAKE_BUILD_TYPE=None \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_INSTALL_LIBEXECDIR=lib \
        -DCMAKE_INSTALL_SYSCONFDIR=/etc
  cmake --build build
}

package() {
  cd "${srcdir}/${pkgname}"
  DESTDIR="${pkgdir}" cmake --install build

  # If Debian splits defaults vs session, you can choose to keep them together,
  # or later create a split package (see notes below).
}
