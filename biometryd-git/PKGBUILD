# Maintainer: You <you@example.com>
pkgname=biometryd-git
_pkgname=biometryd
pkgver=r263.0.3.2
pkgrel=0
pkgdesc="Biometric mediation/aggregation daemon + QML bindings for Lomiri (UBports)"
arch=('x86_64' 'aarch64' 'armv7h')
url="https://salsa.debian.org/ubports-team/biometryd"
license=('GPL3')
depends=(
  dbus
  sqlite
  qt5-base
  qt5-declarative
)
makedepends=(
  nlohmann-json
  cmake
  dbus-cpp
  ninja
  pkgconf
  qt5-tools
  boost
  libelf
  apparmor
  process-cpp
  properties-cpp
)
optdepends=('apparmor: confinement support')
source=("git+https://gitlab.com/ubports/development/core/biometryd.git#branch=main"
        "fix-boost.patch"
)
sha256sums=('SKIP'
            'SKIP'
)

pkgver() {
  cd ${_pkgname}
  ver="r$(git rev-list --count HEAD).$(git describe --always)"
  echo "${ver//-/_}"            # only: hyphens â†’ underscores
}

prepare() {
  cd "${srcdir}/${_pkgname}"
  patch -Np1 -i "${srcdir}/fix-boost.patch"
}

build() {
  cd "$srcdir/${_pkgname}"
  cmake -B build -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_POLICY_VERSION_MINIMUM=3.5
  cmake --build build
}

check() {
  # Upstream tests may be headless-unfriendly; skip by default
  true
}

package() {
  cd "$srcdir/${_pkgname}"
  DESTDIR="$pkgdir" cmake --install build

  # License
  install -Dm644 COPYING "$pkgdir/usr/share/licenses/$pkgname/COPYING"

  # Move qt5 to qt
  mv "${pkgdir}/usr/lib/qt5/" "${pkgdir}/usr/lib/qt/"
}
