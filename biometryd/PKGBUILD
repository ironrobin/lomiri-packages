# Maintainer: You <you@example.com>
pkgname=biometryd
_pkgname=biometryd
pkgver=0.3.2
pkgrel=1
pkgdesc="Biometric mediation/aggregation daemon + QML bindings for Lomiri (UBports)"
arch=('x86_64' 'aarch64' 'armv7h')
url="https://gitlab.com/ubports/development/core/biometryd/-/archive/0.3.2/biometryd-0.3.2.tar.gz"
license=('GPL3')
depends=(
  dbus
  sqlite
  qt5-base
  qt5-declarative
)
makedepends=(
  nlohmann-json
  cmake
  dbus-cpp
  ninja
  pkgconf
  qt5-tools
  boost
  libelf
  apparmor
  process-cpp
  properties-cpp
  gtest
  cmake-extras
)
optdepends=('apparmor: confinement support')
source=("git+https://gitlab.com/ubports/development/core/biometryd.git#branch=main"
        "fix-boost.patch"
        "0001-remove-boost.system.patch"
)
sha256sums=('SKIP'
            '35db377a23061cbeabc7015bebd342758becaf596b2b06b08742ea855f2826e6'
            'eacddc74a9309f5e87b3e948e41dcb3d8a6481de46e984c42257b76010c4ec4e')

# pkgver() {
#   cd ${_pkgname}
#   ver="r$(git rev-list --count HEAD).$(git describe --always)"
#   echo "${ver//-/_}"            # only: hyphens â†’ underscores
# }

prepare() {
  cd "${srcdir}/${_pkgname}"
  patch -Np1 -i "${srcdir}/fix-boost.patch"
  patch -Np1 -i "${srcdir}/0001-remove-boost.system.patch"
}

build() {
  cd "$srcdir/${_pkgname}"
  cmake -B build -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_POLICY_VERSION_MINIMUM=3.5
  cmake --build build
}

check() {
  # Upstream tests may be headless-unfriendly; skip by default
  true
}

package() {
  cd "$srcdir/${_pkgname-}"
  DESTDIR="$pkgdir" cmake --install build

  # License
  install -Dm644 COPYING "$pkgdir/usr/share/licenses/$pkgname/COPYING"

  # Move qt5 to qt
  mv "${pkgdir}/usr/lib/qt5/" "${pkgdir}/usr/lib/qt/"
}
