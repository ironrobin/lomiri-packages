From 0a75c23e384bfae06927e96687316519c109b324 Mon Sep 17 00:00:00 2001
From: Alex R <alex@ironrobin.net>
Date: Mon, 13 Oct 2025 18:40:23 +0000
Subject: [PATCH] link freetype harfbuzz

---
 CMakeLists.txt                         |  7 +++++++
 src/platforms/mirserver/CMakeLists.txt | 10 ++++++++++
 2 files changed, 17 insertions(+)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index e6fc0c59..c4899e88 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -79,6 +79,13 @@ find_package(Qt5Test 5.9 REQUIRED)
 
 find_package(Threads REQUIRED)
 
+# Qt’s FontDatabaseSupport is static and needs Freetype explicitly.
+# Make Freetype available to subdirs and targets created after this point.
+find_package(Freetype REQUIRED)
+if (TARGET Freetype::Freetype)
+  link_libraries(Freetype::Freetype)
+endif()
+
 pkg_check_modules(MIRSERVER mirserver>=0.26 REQUIRED)
 if(WITH_MIR2)
 pkg_check_modules(MIRSERVER mirserver REQUIRED)
diff --git a/src/platforms/mirserver/CMakeLists.txt b/src/platforms/mirserver/CMakeLists.txt
index 01615532..2615ea07 100644
--- a/src/platforms/mirserver/CMakeLists.txt
+++ b/src/platforms/mirserver/CMakeLists.txt
@@ -42,6 +42,11 @@ set(QT5PLATFORMSUPPORT_LIBS
     Qt5ServiceSupport::Qt5ServiceSupport
 )
 
+# Qt’s FontDatabaseSupport is static and needs its deps explicitly.
+# FreeType via CMake, HarfBuzz via pkg-config (portable across distros).
+find_package(Freetype REQUIRED)
+pkg_check_modules(HARFBUZZ REQUIRED harfbuzz)
+
 include_directories(
     ${CMAKE_SOURCE_DIR}/include
     ${CMAKE_SOURCE_DIR}/src/common
@@ -82,6 +87,9 @@ endif()
     ${VALGRIND_INCLUDE_DIRS}
 )
 
+# HarfBuzz headers (not strictly needed here, but harmless and clearer)
+include_directories(SYSTEM ${HARFBUZZ_INCLUDE_DIRS})
+
 # We have to remove -pedantic for tracepoints.c
 string (REPLACE " -pedantic " " " TRACEPOINTS_CMAKE_C_FLAGS ${CMAKE_C_FLAGS})
 # BYTE_ORDER needed to compile tracepoints in C99 mode.
@@ -217,6 +225,8 @@ target_link_libraries(qtmirserver
         Qt5::Quick
         Qt5::Sensors
         ${QT5PLATFORMSUPPORT_LIBS}
+        Freetype::Freetype
+        ${HARFBUZZ_LIBRARIES}
 )
 
 set_target_properties(qtmirserver
