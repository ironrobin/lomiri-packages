# Maintainer: Ivan Semkin (ivan at semkin dot ru)

pkgname=lomiri-thumbnailer
_pkgname=lomiri-thumbnailer
pkgver=3.0.5
pkgrel=1
pkgdesc='D-Bus service for out of process thumbnailing'
url='https://gitlab.com/ubports/development/core/lomiri-thumbnailer'
arch=(x86_64 i686 armv7h aarch64)
license=(GPL)
conflicts=(lomiri-thumbnailer)
provides=(lomiri-thumbnailer)
depends=(boost qt5-base qt5-quickcontrols gstreamer gst-plugins-base gdk-pixbuf2 libexif lomiri-api apparmor taglib persistent-cache-cpp)
makedepends=(git cmake)
source=('https://gitlab.com/ubports/development/core/lomiri-thumbnailer/-/archive/3.0.5/lomiri-thumbnailer-3.0.5.tar.gz'
        '0001-work-with-new-cmake.patch'
        '0002-taglib-2.0-and-stdexcept-fixes.patch')
sha256sums=('75821bfc4f8dc35074f4cd4c0f284759856158563c8f47b37ce06076b0db42cc'
            '9c17cb42ef6bcb0b8acd35496d4ce91f1f20d87aa41c8da3460520e9f9901df6'
            '4c3f14c25bba18e22b6244f6f73588a85db7f23214193ceb36fb848c6e5a6c2c')

prepare() {
  cd ${_pkgname}-$pkgver
  # TODO: See if these need to be applied upstream
  # patch -Np1 -i "${srcdir}/0001-work-with-new-cmake.patch"
  # patch -Np1 -i "${srcdir}/0002-taglib-2.0-and-stdexcept-fixes.patch"
}

# pkgver() {
#   cd ${_pkgname}
#   echo "r$(git rev-list --count HEAD).$(git describe --always)" | sed 's/\([^-]*-g\)/r\1/;s/-/./g'
# }

build() {
  cd ${_pkgname}-$pkgver
  cmake -DCMAKE_INSTALL_PREFIX:PATH=/usr \
    -DBUILD_TESTING=OFF \
    -DSLOW_TESTS=OFF \
    -Dskip-dbus-tests=ON \
    -DCMAKE_INSTALL_LIBDIR="lib/" .
  make
}

package() {
  cd ${_pkgname}-$pkgver
  make DESTDIR="${pkgdir}/" install
  mv ${pkgdir}/usr/lib/qt5/ ${pkgdir}/usr/lib/qt/
}
# vim:set ts=2 sw=2 et:
