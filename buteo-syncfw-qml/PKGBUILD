# Maintainer: Furkan Kardame <furkan@fkardame.com>

pkgname=buteo-syncfw-qml
_pkgname=buteo-syncfw-qml
pkgver=0.3
pkgrel=1
pkgdesc='Buteo sync framework client - QML bindings'
url='https://gitlab.com/ubports/development/core/buteo-syncfw-qml'
arch=(x86_64 i686 armv7h aarch64)
license=()
depends=(qt5-base qt5-declarative)
makedepends=(git cmake cmake-extras curl)
source=(
  'https://gitlab.com/ubports/development/core/buteo-syncfw-qml/-/archive/0.3/buteo-syncfw-qml-0.3.tar.gz'
)
sha256sums=('SKIP')

# pkgver() {
#  cd ${_pkgname}
#  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
# }

prepare() {
  cd ${_pkgname}-${pkgver}
  # Fetch and apply Debian patches dynamically (not tracked in source array)
  local baseurl='https://salsa.debian.org/ubports-team/buteo-syncfw-qml/-/raw/master/debian/patches'
  local series_url="$baseurl/series"
  local patchdir="$srcdir/debian-patches"
  mkdir -p "$patchdir"

  # Download series file
  curl -fsSL "$series_url" -o "$patchdir/series"

  # Download and apply each patch listed in series (skip comments/empties)
  while IFS= read -r p; do
    [[ -z "$p" || "$p" =~ ^# ]] && continue
    curl -fsSL "$baseurl/$p" -o "$patchdir/$p"
    patch -Np1 -i "$patchdir/$p"
  done < "$patchdir/series"
}

build() {
  cd ${_pkgname}-${pkgver}
  mkdir -p build
  cd build
  cmake ../ -DCMAKE_POLICY_VERSION_MINIMUM=3.5 -DCMAKE_INSTALL_PREFIX:PATH=/usr -DCMAKE_INSTALL_LIBDIR="lib/" -DCMAKE_INSTALL_SYSCONFDIR=/etc -DCMAKE_INSTALL_LOCALSTATEDIR=/var
  make

}

package() {
  cd ${_pkgname}-${pkgver}/build
  make DESTDIR="${pkgdir}/" install
}
